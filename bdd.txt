CREATE DATABASE hsp_urgences
    CHARACTER SET utf8mb4
    COLLATE utf8mb4_general_ci;

USE hsp_urgences;

CREATE TABLE utilisateur (
    id_utilisateur INT PRIMARY KEY AUTO_INCREMENT,
    nom VARCHAR(50) NOT NULL,
    prenom VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    mot_de_passe VARCHAR(255) NOT NULL,
    role ENUM('Secretaire', 'Medecin', 'Gestionnaire') NOT NULL,
    date_creation DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

CREATE TABLE connexion (
    id_connexion INT PRIMARY KEY AUTO_INCREMENT,
    id_utilisateur INT NOT NULL,
    date_connexion DATETIME DEFAULT CURRENT_TIMESTAMP,
    ip_adresse VARCHAR(45)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

CREATE TABLE historique (
    id_historique INT PRIMARY KEY AUTO_INCREMENT,
    id_utilisateur INT NOT NULL,
    action VARCHAR(50) NOT NULL,
    table_concernee VARCHAR(50) NOT NULL,
    id_enregistrement INT,
    date_action DATETIME DEFAULT CURRENT_TIMESTAMP,
    details TEXT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

CREATE TABLE patient (
    id_patient INT PRIMARY KEY AUTO_INCREMENT,
    nom VARCHAR(50) NOT NULL,
    prenom VARCHAR(50) NOT NULL,
    num_secu VARCHAR(15) UNIQUE NOT NULL,
    email VARCHAR(100),
    telephone VARCHAR(15),
    adresse TEXT,
    date_creation DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

CREATE TABLE dossier (
    id_dossier INT PRIMARY KEY AUTO_INCREMENT,
    id_patient INT NOT NULL,
    id_secretaire INT NOT NULL,
    id_medecin INT,
    date_arrivee DATETIME NOT NULL,
    symptomes TEXT,
    niveau_gravite INT NOT NULL CHECK(niveau_gravite BETWEEN 1 AND 5),
    statut ENUM('Attente', 'EnCours', 'Termine') DEFAULT 'Attente',
    date_creation DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

CREATE TABLE chambre (
    id_chambre INT PRIMARY KEY AUTO_INCREMENT,
    numero VARCHAR(10) UNIQUE NOT NULL,
    etage INT NOT NULL,
    nb_lits INT DEFAULT 1,
    disponible BOOLEAN DEFAULT TRUE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

CREATE TABLE hospitalisation (
    id_hospitalisation INT PRIMARY KEY AUTO_INCREMENT,
    id_dossier INT NOT NULL,
    id_chambre INT NOT NULL,
    id_medecin INT NOT NULL,
    date_debut DATETIME NOT NULL,
    date_fin DATETIME,
    description_maladie TEXT,
    date_creation DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

CREATE TABLE produit (
    id_produit INT PRIMARY KEY AUTO_INCREMENT,
    libelle VARCHAR(100) NOT NULL,
    description TEXT,
    niveau_dangerosite INT NOT NULL CHECK(niveau_dangerosite BETWEEN 1 AND 5),
    quantite_stock INT DEFAULT 0,
    date_creation DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

CREATE TABLE fournisseur (
    id_fournisseur INT PRIMARY KEY AUTO_INCREMENT,
    nom VARCHAR(100) NOT NULL,
    contact VARCHAR(100),
    email VARCHAR(100),
    telephone VARCHAR(15),
    adresse TEXT,
    date_creation DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

CREATE TABLE produit_fournisseur (
    id_produit INT NOT NULL,
    id_fournisseur INT NOT NULL,
    prix DECIMAL(10,2) NOT NULL,
    PRIMARY KEY (id_produit, id_fournisseur)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

CREATE TABLE demande_produit (
    id_demande INT PRIMARY KEY AUTO_INCREMENT,
    id_medecin INT NOT NULL,
    id_produit INT NOT NULL,
    id_gestionnaire INT,
    quantite INT NOT NULL,
    date_demande DATETIME DEFAULT CURRENT_TIMESTAMP,
    statut ENUM('Attente', 'Validee', 'Refusee') DEFAULT 'Attente',
    motif_refus TEXT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

CREATE TABLE reapprovisionnement (
    id_reappro INT PRIMARY KEY AUTO_INCREMENT,
    id_produit INT NOT NULL,
    id_fournisseur INT NOT NULL,
    id_gestionnaire INT NOT NULL,
    quantite INT NOT NULL,
    date_commande DATETIME DEFAULT CURRENT_TIMESTAMP,
    date_reception DATETIME
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

ALTER TABLE connexion
    ADD CONSTRAINT fk_connexion_utilisateur
        FOREIGN KEY (id_utilisateur) REFERENCES utilisateur(id_utilisateur)
        ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE historique
    ADD CONSTRAINT fk_historique_utilisateur
        FOREIGN KEY (id_utilisateur) REFERENCES utilisateur(id_utilisateur)
        ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE dossier
    ADD CONSTRAINT fk_dossier_patient
        FOREIGN KEY (id_patient) REFERENCES patient(id_patient)
        ON DELETE CASCADE ON UPDATE CASCADE,
    ADD CONSTRAINT fk_dossier_secretaire
        FOREIGN KEY (id_secretaire) REFERENCES utilisateur(id_utilisateur)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    ADD CONSTRAINT fk_dossier_medecin
        FOREIGN KEY (id_medecin) REFERENCES utilisateur(id_utilisateur)
        ON DELETE SET NULL ON UPDATE CASCADE;

ALTER TABLE hospitalisation
    ADD CONSTRAINT fk_hospitalisation_dossier
        FOREIGN KEY (id_dossier) REFERENCES dossier(id_dossier)
        ON DELETE CASCADE ON UPDATE CASCADE,
    ADD CONSTRAINT fk_hospitalisation_chambre
        FOREIGN KEY (id_chambre) REFERENCES chambre(id_chambre)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    ADD CONSTRAINT fk_hospitalisation_medecin
        FOREIGN KEY (id_medecin) REFERENCES utilisateur(id_utilisateur)
        ON DELETE RESTRICT ON UPDATE CASCADE;

ALTER TABLE produit_fournisseur
    ADD CONSTRAINT fk_prodfour_produit
        FOREIGN KEY (id_produit) REFERENCES produit(id_produit)
        ON DELETE CASCADE ON UPDATE CASCADE,
    ADD CONSTRAINT fk_prodfour_fournisseur
        FOREIGN KEY (id_fournisseur) REFERENCES fournisseur(id_fournisseur)
        ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE demande_produit
    ADD CONSTRAINT fk_demande_medecin
        FOREIGN KEY (id_medecin) REFERENCES utilisateur(id_utilisateur)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    ADD CONSTRAINT fk_demande_produit
        FOREIGN KEY (id_produit) REFERENCES produit(id_produit)
        ON DELETE CASCADE ON UPDATE CASCADE,
    ADD CONSTRAINT fk_demande_gestionnaire
        FOREIGN KEY (id_gestionnaire) REFERENCES utilisateur(id_utilisateur)
        ON DELETE SET NULL ON UPDATE CASCADE;

ALTER TABLE reapprovisionnement
    ADD CONSTRAINT fk_reappro_produit
        FOREIGN KEY (id_produit) REFERENCES produit(id_produit)
        ON DELETE CASCADE ON UPDATE CASCADE,
    ADD CONSTRAINT fk_reappro_fournisseur
        FOREIGN KEY (id_fournisseur) REFERENCES fournisseur(id_fournisseur)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    ADD CONSTRAINT fk_reappro_gestionnaire
        FOREIGN KEY (id_gestionnaire) REFERENCES utilisateur(id_utilisateur)
        ON DELETE RESTRICT ON UPDATE CASCADE;

CREATE INDEX idx_utilisateur_email ON utilisateur(email);
CREATE INDEX idx_utilisateur_role ON utilisateur(role);
CREATE INDEX idx_patient_num_secu ON patient(num_secu);
CREATE INDEX idx_patient_nom ON patient(nom, prenom);
CREATE INDEX idx_dossier_statut ON dossier(statut);
CREATE INDEX idx_dossier_date ON dossier(date_arrivee);
CREATE INDEX idx_chambre_dispo ON chambre(disponible);
CREATE INDEX idx_produit_stock ON produit(quantite_stock);
CREATE INDEX idx_demande_statut ON demande_produit(statut);
CREATE INDEX idx_historique_date ON historique(date_action);

INSERT INTO utilisateur (nom, prenom, email, mot_de_passe, role) VALUES
('Dupont', 'Marie', 'marie.dupont@hopital.fr', '$2a$10$xJwL5v5Jz5U5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z', 'Secretaire'),
('Martin', 'Jean', 'jean.martin@hopital.fr', '$2a$10$xJwL5v5Jz5U5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z', 'Medecin'),
('Bernard', 'Sophie', 'sophie.bernard@hopital.fr', '$2a$10$xJwL5v5Jz5U5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z', 'Medecin'),
('Petit', 'Lucas', 'lucas.petit@hopital.fr', '$2a$10$xJwL5v5Jz5U5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z5Z', 'Gestionnaire');

INSERT INTO chambre (numero, etage, nb_lits, disponible) VALUES
('101', 1, 2, TRUE),
('102', 1, 1, TRUE),
('103', 1, 2, FALSE),
('201', 2, 1, TRUE),
('202', 2, 2, TRUE),
('203', 2, 1, FALSE);

INSERT INTO patient (nom, prenom, num_secu, email, telephone, adresse) VALUES
('Leroy', 'Pierre', '185126912345678', 'pierre.leroy@email.com', '0612345678', '12 rue de Paris, 75001 Paris'),
('Moreau', 'Claire', '285126987654321', 'claire.moreau@email.com', '0698765432', '5 avenue Victor Hugo, 69001 Lyon'),
('Garcia', 'Antoine', '190056712345678', 'antoine.garcia@email.com', '0654321987', '8 boulevard Gambetta, 33000 Bordeaux');

INSERT INTO produit (libelle, description, niveau_dangerosite, quantite_stock) VALUES
('Paracétamol 500mg', 'Antalgique et antipyrétique', 1, 500),
('Morphine 10mg', 'Analgésique opioïde', 5, 50),
('Ibuprofène 400mg', 'Anti-inflammatoire', 2, 300),
('Amoxicilline 1g', 'Antibiotique', 2, 200),
('Adrénaline 1mg', 'Urgence cardiaque', 4, 100);

INSERT INTO fournisseur (nom, contact, email, telephone) VALUES
('PharmaPlus', 'Jean Durand', 'contact@pharmaplus.fr', '0145678901'),
('MediStock', 'Anne Laurent', 'commande@medistock.fr', '0156789012'),
('SantéPro', 'Marc Dubois', 'pro@santepro.fr', '0167890123');

INSERT INTO produit_fournisseur (id_produit, id_fournisseur, prix) VALUES
(1, 1, 2.50),
(1, 2, 2.30),
(2, 1, 15.00),
(2, 3, 14.50),
(3, 2, 4.00),
(4, 1, 8.00),
(4, 2, 7.50),
(5, 3, 25.00);

INSERT INTO dossier (id_patient, id_secretaire, id_medecin, date_arrivee, symptomes, niveau_gravite, statut) VALUES
(1, 1, 2, NOW(), 'Douleurs thoraciques, essoufflement', 4, 'EnCours'),
(2, 1, 3, NOW() - INTERVAL 2 HOUR, 'Fièvre, maux de tête', 2, 'Attente'),
(3, 1, 2, NOW() - INTERVAL 1 DAY, 'Fracture du bras', 3, 'Termine');

CREATE VIEW vue_patients_attente AS
SELECT
    d.id_dossier,
    p.nom AS patient_nom,
    p.prenom AS patient_prenom,
    d.date_arrivee,
    d.symptomes,
    d.niveau_gravite,
    u.nom AS medecin_nom,
    u.prenom AS medecin_prenom
FROM dossier d
JOIN patient p ON d.id_patient = p.id_patient
LEFT JOIN utilisateur u ON d.id_medecin = u.id_utilisateur
WHERE d.statut = 'Attente'
ORDER BY d.niveau_gravite DESC, d.date_arrivee ASC;

CREATE VIEW vue_stock_faible AS
SELECT
    p.id_produit,
    p.libelle,
    p.quantite_stock,
    p.niveau_dangerosite
FROM produit p
WHERE p.quantite_stock < 50
ORDER BY p.quantite_stock ASC;

CREATE VIEW vue_chambres_disponibles AS
SELECT
    id_chambre,
    numero,
    etage,
    nb_lits
FROM chambre
WHERE disponible = TRUE
ORDER BY etage, numero;